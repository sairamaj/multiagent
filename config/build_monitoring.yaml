# Build Monitoring Configuration
# This file contains Azure DevOps pipeline monitoring and alerting rules

# Pipeline Monitoring Settings
pipeline_monitoring:
  # Check interval in minutes
  check_interval_minutes: 5
  
  # Monitor these pipelines
  monitored_pipelines:
    - name: "CI-Main"
      project: "MyProject"
      alert_on_failure: true
      alert_threshold: 2  # Alert after N consecutive failures
    
    - name: "CD-Production"
      project: "MyProject"
      alert_on_failure: true
      alert_threshold: 1  # Alert immediately
    
    - name: "Nightly-Tests"
      project: "MyProject"
      alert_on_failure: true
      alert_threshold: 3
  
  # Alert channels
  alert_channels:
    email:
      enabled: true
      recipients:
        - "devops-team@example.com"
        - "build-alerts@example.com"
    
    teams:
      enabled: true
      webhook_url: "${TEAMS_WEBHOOK_URL}"  # From environment variable
    
    slack:
      enabled: false
      webhook_url: "${SLACK_WEBHOOK_URL}"

# Build Failure Analysis
build_failure_analysis:
  # Automatically analyze failed builds
  auto_analyze: true
  
  # Common failure patterns to detect
  failure_patterns:
    - pattern: "OutOfMemoryError"
      category: "memory"
      severity: "high"
      suggested_action: "Increase build agent memory allocation"
    
    - pattern: "Connection timed out"
      category: "network"
      severity: "medium"
      suggested_action: "Check network connectivity and retry"
    
    - pattern: "Test failed: .*"
      category: "test"
      severity: "medium"
      suggested_action: "Review test failure details"
    
    - pattern: "npm ERR!"
      category: "dependency"
      severity: "medium"
      suggested_action: "Check npm package dependencies"
    
    - pattern: "docker: Error response from daemon"
      category: "docker"
      severity: "high"
      suggested_action: "Check Docker daemon and image availability"
  
  # Store analysis results
  store_analysis: true
  analysis_retention_days: 90

# Build Performance Metrics
performance_metrics:
  # Track build duration
  track_duration: true
  
  # Alert if build duration exceeds threshold (minutes)
  duration_threshold_minutes: 60
  
  # Track queue time
  track_queue_time: true
  
  # Alert if queue time exceeds threshold (minutes)
  queue_threshold_minutes: 30
  
  # Track success rate
  track_success_rate: true
  
  # Alert if success rate drops below percentage
  success_rate_threshold_percent: 80
  
  # Calculate metrics over this window (days)
  metrics_window_days: 7

# Build Agent Monitoring
build_agents:
  # Monitor agent availability
  monitor_agents: true
  
  # Alert if available agents drop below this number
  min_available_agents: 2
  
  # Agent pools to monitor
  monitored_pools:
    - "Default"
    - "Azure Pipelines"
    - "Custom-Pool"
  
  # Alert on agent failures
  alert_on_agent_failure: true

# Deployment Monitoring
deployment_monitoring:
  # Monitor deployment stages
  monitor_deployments: true
  
  # Environments to monitor
  monitored_environments:
    - name: "Production"
      require_approval: true
      alert_on_failure: true
      rollback_on_failure: false
    
    - name: "Staging"
      require_approval: false
      alert_on_failure: true
      rollback_on_failure: true
    
    - name: "Development"
      require_approval: false
      alert_on_failure: false
      rollback_on_failure: false
  
  # Track deployment frequency
  track_deployment_frequency: true
  
  # Track deployment duration
  track_deployment_duration: true
  
  # Alert if deployment duration exceeds threshold (minutes)
  deployment_duration_threshold_minutes: 120

# Artifact Management
artifact_management:
  # Maximum artifact retention days
  max_retention_days: 90
  
  # Minimum retention days (compliance)
  min_retention_days: 30
  
  # Artifact size limits (MB)
  max_artifact_size_mb: 1024
  
  # Alert if artifact size exceeds limit
  alert_on_size_limit: true
  
  # Automatically cleanup old artifacts
  auto_cleanup: true

# Quality Gates
quality_gates:
  # Enforce quality gates
  enforce_gates: true
  
  # Gate criteria
  gates:
    - name: "Code Coverage"
      metric: "coverage"
      threshold: 80
      operator: "greater_than"
      required: true
    
    - name: "Test Pass Rate"
      metric: "test_pass_rate"
      threshold: 95
      operator: "greater_than"
      required: true
    
    - name: "Critical Bugs"
      metric: "critical_bugs"
      threshold: 0
      operator: "equals"
      required: true
    
    - name: "Security Scan"
      metric: "security_score"
      threshold: 7
      operator: "greater_than"
      required: false

# Integration Settings
integrations:
  # Azure DevOps connection
  azure_devops:
    organization: "${AZURE_DEVOPS_ORG}"  # From environment variable
    pat_secret_name: "azure-devops-pat"  # From Key Vault
    api_version: "7.0"
  
  # Application Insights for logging
  app_insights:
    enabled: true
    instrumentation_key_secret: "app-insights-key"  # From Key Vault
  
  # Azure Monitor for alerting
  azure_monitor:
    enabled: true
    workspace_id: "${AZURE_MONITOR_WORKSPACE}"  # From environment variable

# Reporting
reporting:
  # Generate daily build reports
  daily_reports: true
  
  # Generate weekly summary reports
  weekly_reports: true
  
  # Report recipients
  report_recipients:
    - "devops-team@example.com"
    - "management@example.com"
  
  # Include metrics in reports
  include_metrics:
    - "build_success_rate"
    - "average_build_duration"
    - "deployment_frequency"
    - "failure_recovery_time"
  
  # Report format
  report_format: "html"
  
  # Store reports in blob storage
  store_reports: true
  report_container: "build-reports"
